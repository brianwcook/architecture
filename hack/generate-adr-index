#!/bin/bash
# Generate ADR/index.md with a list of all Architecture Decision Records

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
ADR_DIR="${REPO_ROOT}/ADR"
INDEX_FILE="${ADR_DIR}/index.md"

# Start the index file with front matter
cat > "${INDEX_FILE}" << 'EOF'
---
title: Architecture Decision Records
eleventyNavigation:
  key: Architecture Decision Records
  order: 3
  url: /architecture/ADR/
toc: true
---

# Architecture Decision Records

An Architecture Decision Record (ADR) is a document that captures an important architectural decision made along with its context and consequences.

## ADR List

EOF

# Process all ADR files in order
for adr_file in "${ADR_DIR}"/*.md; do
  # Skip the index file itself and the template
  filename=$(basename "${adr_file}")
  if [[ "${filename}" == "index.md" ]] || [[ "${filename}" == "0000-adr-template.md" ]]; then
    continue
  fi

  # Extract the ADR number from the filename
  if [[ "${filename}" =~ ^([0-9]{4})- ]]; then
    adr_num="${BASH_REMATCH[1]}"
  else
    continue
  fi

  # Extract title (first H1 after front matter)
  title=$(sed -n '/^---$/,/^---$/d; /^# /{ s/^# //; p; q }' "${adr_file}")

  # Extract status
  status=$(sed -n '/^## Status$/{ n; p; q }' "${adr_file}" | sed 's/^[[:space:]]*//')

  # Clean the filename for the link (remove .md extension)
  link_name="${filename%.md}"

  # Add entry to index
  if [[ -n "${status}" ]]; then
    echo "- [${title}](./${link_name}/) - **${status}**" >> "${INDEX_FILE}"
  else
    echo "- [${title}](./${link_name}/)" >> "${INDEX_FILE}"
  fi
done

echo "âœ… Generated ${INDEX_FILE}"
